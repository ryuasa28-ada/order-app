<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>注文フォーム（デモ）</title>
<style>
  :root{
    --brand:#3c3a38;--ink:#111;--muted:#666;--card:#fff;--bg:#fafafa;
    --radius:14px;--shadow:0 6px 22px rgba(0,0,0,.08);
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
  .app{max-width:1100px;margin:24px auto;padding:0 16px 80px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  header .logo{font-weight:800;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px}
  .grid{display:grid;gap:16px}
  .g2{grid-template-columns:280px 1fr}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  h2{margin:0 0 10px 0}
  .muted{color:var(--muted);font-size:.92rem}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer;background:#eee}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-danger{background:#ef4444;color:#fff}
  .btn-ghost{background:#f4f4f5}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .kv{margin:8px 0}
  .kv b{display:inline-block;min-width:7em;color:#333}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px solid #eee;border-radius:12px;padding:12px;cursor:pointer;background:#fff}
  .item.active{outline:3px solid #3b82f680}
  .pill{display:inline-block;border-radius:999px;background:#f1f5f9;padding:2px 8px;font-size:.8rem;margin-left:6px}
  .sum{font-weight:800;font-size:1.1rem}
  .hr{height:1px;background:#eee;margin:12px 0}

  /* ===== Mobile polish for final-check ===== */
@media (max-width: 860px){
  .app{padding:0 10px 120px;}                 /* 下部にCTAぶんの余白 */
  header{flex-wrap:wrap; gap:10px}
  .grid.g2{grid-template-columns:1fr}         /* 1カラム化 */
  aside.card, main.card{padding:16px}
  h2{font-size:1.06rem}
  .btn{padding:12px 16px; font-size:.95rem}   /* タップ領域UP */
  .item{padding:14px}
  .item .muted{font-size:.9rem; line-height:1.4}
  .item .sum{font-size:1rem}
  .list{gap:12px}
  .kv{margin:10px 0}
  .kv b{min-width:6em}
}

/* 見やすさUP */
.item{border:2px solid #e6e6e6; border-radius:14px;}
.item.active{border-color:#8bb6ff; box-shadow:0 0 0 4px #8bb6ff33}
.muted{word-break:break-word}
#detailArea .kv b{color:#222}
#grandTotal{font-size:1.2rem}

/* 画面下の固定CTA（スマホ） */
.mobile-cta{
  position:fixed; left:0; right:0; bottom:0;
  display:flex; gap:10px; padding:12px 14px;
  background:linear-gradient(180deg, rgba(250,250,250,.0), rgba(250,250,250,.9) 20%, #fafafa 60%);
  backdrop-filter:saturate(140%) blur(8px);
  border-top:1px solid #eee;
}
.mobile-cta .btn{flex:1}
.mobile-cta .btn-primary{flex:2}
@media (min-width: 861px){ .mobile-cta{display:none} }
</style>
</head>
<body>

<!-- ===== Mobile sticky CTA ===== -->
<div class="mobile-cta" aria-label="送信操作">
  <!-- header の戻る -->
<button class="btn" id="btn-back">← 戻る</button>
  <button class="btn btn-primary" id="m-submit">この内容で送信（デモ）</button>
</div>
<div class="app">
  <header>
    <div class="logo">山本農園</div>
    <div class="row">
      <button class="btn" onclick="history.back()">← 戻る</button>
      <button class="btn btn-primary" id="btn-submit">この内容で送信（デモ）</button>
    </div>
  </header>

  <div class="grid g2">
    <!-- 左：送り先一覧 -->
    <aside class="card">
      <h2>送り先一覧 <span class="muted" id="count"></span></h2>
      <div class="list" id="recipients"></div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="addMore">＋ 送り先を追加</button>
        <button class="btn" id="editOnIndex">この送り先を編集</button>
        <button class="btn btn-danger" id="delete">削除</button>
        <!-- <button class="btn" id="toggleConfirm">確定にする/外す</button> -->
      </div>
    </aside>

    <!-- 右：詳細 -->
    <main class="card">
      <h2>注文詳細</h2>
      <div id="buyerArea" class="kv"></div>
      <div class="row" id="buyerActions">
        <button class="btn" id="editBuyer">注文者を編集</button>
      </div>

      <div class="hr"></div>

      <h2>選択中の送り先</h2>
      <div id="detailArea"></div>

      <div class="hr"></div>

      <div class="row">
        <div class="sum">総合計（送料別）: <span id="grandTotal">¥0</span></div>
      </div>
    </main>
  </div>
</div>

<script>
// ===== DEMO: 受け渡し（sessionStorage） =====
let buyer = JSON.parse(sessionStorage.getItem('buyer') || '{}');
let orders = JSON.parse(sessionStorage.getItem('ordersDraft') || '[]');
// 各 order: { buyer:{...}, recipient:{...}, product:{...}, confirmed?:bool }

// UI state
let current = 0;

// ===== ユーティリティ =====
const yen = n => (n||0).toLocaleString('ja-JP',{style:'currency',currency:'JPY',minimumFractionDigits:0});

function calcOrderTotal(o){
  const map = { '5kg':3500, '10kg':7000, '15kg':10500 };
  const w = o?.product?.modal_weight;
  const n = parseInt(o?.product?.modal_box_count || '0', 10);
  return (map[w] || 0) * n;
}
function calcGrandTotal(){ return orders.reduce((sum,o)=> sum + calcOrderTotal(o), 0); }
function el(sel){ return document.querySelector(sel); }
function div(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }

// ===== ここから追加：index.html へ戻すナビ関数 =====
function goIndex({ startAt = 'recipient', editIndex = null, addNew = false, buyerEdit = false } = {}) {
  sessionStorage.setItem('buyer', JSON.stringify(buyer));
  sessionStorage.setItem('ordersDraft', JSON.stringify(orders));

  if (startAt) sessionStorage.setItem('startAt', startAt); else sessionStorage.removeItem('startAt');
  if (editIndex !== null && editIndex !== undefined) {
    sessionStorage.setItem('editIndex', String(editIndex));
  } else {
    sessionStorage.removeItem('editIndex');
  }
  if (addNew) sessionStorage.setItem('addNew', 'true'); else sessionStorage.removeItem('addNew');
// ★ 注文者編集フラグ
  if (buyerEdit) sessionStorage.setItem('buyerEdit', '1');
  else sessionStorage.removeItem('buyerEdit');

  location.href = 'index.html';
}
// ===== 追加ここまで =====

// ===== 描画 =====
function renderBuyer(){
  const html = `
    <div class="kv"><b>氏名</b>${buyer.name || '-'}</div>
    <div class="kv"><b>電話</b>${buyer.phone_number || '-'}</div>
    <div class="kv"><b>メール</b>${buyer.email || '-'}</div>
    <div class="kv"><b>住所</b>${(buyer.prefecture||'')+(buyer.city||'')+(buyer.address_details||'')}${buyer.building? ' ' + buyer.building : ''}</div>
    ${buyer.remarks ? `<div class="kv"><b>備考</b>${buyer.remarks}</div>` : '' }
  `;
  el('#buyerArea').innerHTML = html;
}

function renderList(){
  const wrap = el('#recipients');
  wrap.innerHTML = '';
  orders.forEach((o,i)=>{
    const t = calcOrderTotal(o);
    const d = div(`
      <div class="item ${i===current?'active':''}" data-i="${i}">
        <div><b>${o.recipient?.name || '-'}</b>
          ${o.confirmed ? '<span class="pill">確定</span>' : ''}
        </div>
        <div class="muted" style="margin-top:2px;">${(o.recipient?.pref||'')+(o.recipient?.city||'')+(o.recipient?.addr3||'')}</div>
        <div class="muted">${o.product?.modal_product_name || '-'} / ${o.product?.modal_grade1||''}${o.product?.modal_grade||''} / ${o.product?.modal_size||'-'} / ${o.product?.modal_weight||'-'} / 箱:${o.product?.modal_box_count||'-'}</div>
        <div class="sum" style="margin-top:4px;">${yen(t)}</div>
      </div>
    `);
    d.onclick = ()=>{ current = i; renderAll(); };
    wrap.appendChild(d);
  });
  el('#count').textContent = `全 ${orders.length} 件`;
}

function renderDetail(){
  const o = orders[current];
  if(!o){ el('#detailArea').innerHTML = '<div class="muted">送り先がありません。</div>'; return; }
  const r = o.recipient || {};
  const p = o.product || {};
  const t = calcOrderTotal(o);
  el('#detailArea').innerHTML = `
    <div class="kv"><b>送り先氏名</b>${r.name || '-'}</div>
    <div class="kv"><b>電話</b>${r.tel || '-'}</div>
    <div class="kv"><b>住所</b>${(r.pref||'')+(r.city||'')+(r.addr3||'')}${r.addr4? ' ' + r.addr4 : ''}</div>
    <div class="hr"></div>
    <div class="kv"><b>品種</b>${p.modal_product_name || '-'}</div>
    <div class="kv"><b>等級</b>${(p.modal_grade1||'')}${(p.modal_grade||'')}</div>
    <div class="kv"><b>サイズ</b>${p.modal_size || '-'}</div>
    <div class="kv"><b>重量</b>${p.modal_weight || '-'}</div>
    <div class="kv"><b>箱数</b>${p.modal_box_count || '-'}</div>
    <div class="kv sum"><b>金額（送料別）</b>${yen(t)}</div>
  `;
  el('#grandTotal').textContent = yen(calcGrandTotal());
}

function renderAll(){ renderList(); renderDetail(); }

// ===== 操作ボタン =====
el('#addMore').onclick = ()=>{
  // 送付先の追加：index.html を送付先ステップから開始、n+1件目として登録
  goIndex({ startAt: 'recipient', addNew: true });
};

el('#editOnIndex').onclick = ()=>{
  if(!orders[current]) return;
  // 送付先の編集：index.html 側で editIndex をもとに復元
  goIndex({ startAt: 'recipient', editIndex: current });
};

el('#editBuyer').onclick = ()=>{
  // 注文者の編集：index.html を注文者ステップから開始
  goIndex({ startAt: 'buyer', buyerEdit: true });
};

el('#delete').onclick = ()=>{
  if(!orders[current]) return;
  if(!confirm('この送り先を削除しますか？')) return;
  orders.splice(current,1);
  if(current >= orders.length) current = Math.max(0, orders.length-1);
  sessionStorage.setItem('ordersDraft', JSON.stringify(orders));
  renderAll();
};

// el('#toggleConfirm').onclick = ()=>{
//   if(!orders[current]) return;
//   orders[current].confirmed = !orders[current].confirmed;
//   sessionStorage.setItem('ordersDraft', JSON.stringify(orders));
//   renderAll();
// };

// ===== 送信（本番: submit.php へPOST） =====
function buildPayloadForSubmit() {
  const formData = {
    name: buyer.name || '',
    postal_code: buyer.postal_code || '',
    prefecture: buyer.prefecture || '',
    city: buyer.city || '',
    address_details: buyer.address_details || '',
    building: buyer.building || '',
    phone_number: buyer.phone_number || '',
    email: buyer.email || '',
    remarks: buyer.remarks || '',
    // セッションに orderType を入れていれば使う。無ければ NL
    type: sessionStorage.getItem('orderType') || 'NL'
  };

  const destinations = (orders || []).map(o => {
    const r = o?.recipient || {};
    const p = o?.product   || {};
    return {
      name: r.name || '',
      phoneNumber: r.tel || '',
      postalCode: r.zip || '',
      prefecture: r.pref || '',
      city: r.city || '',
      addressDetails: r.addr3 || '',
      building: r.addr4 || '',
      productName: p.modal_product_name || '',
      // PHP 側の期待： grade1 = 等級1, grade = 等級2
      grade1: p.modal_grade1 || '',
      grade:  p.modal_grade  || '',
      size:   p.modal_size   || '',
      weight: p.modal_weight || '',
      boxCount: String(p.modal_box_count || '1'),
      // PHP は非数字を除去して整数化するので、通貨書式でOK
      estimatedCost: yen(calcOrderTotal(o))
    };
  });
  return { formData, destinations };
}

const btnSubmit = document.getElementById('btn-submit');
btnSubmit.onclick = async () => {
  if (!orders || orders.length === 0) {
    alert('送り先がありません。最低1件追加してください。');
    return;
  }
  // 簡易必須チェック（注文者の主要フィールド）
  const must = ['name','phone_number','email','postal_code','prefecture','city','address_details'];
  const missing = must.filter(k => !(buyer?.[k] || '').trim());
  if (missing.length) {
    alert('注文者の必須項目が未入力です。入力画面に戻ってご確認ください。');
    return;
  }

  const payload = buildPayloadForSubmit();

  // 送信中UI
  const prevLabel = btnSubmit.textContent;
  btnSubmit.disabled = true;
  btnSubmit.textContent = '送信中…';

  try {
    const res = await fetch('submit.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json().catch(() => ({}));
    if (!res.ok || json.success === false) {
      throw new Error(json.error || '送信に失敗しました');
    }

    alert(`送信が完了しました。注文番号: ${json.order_id}`);

    // 成功時はセッションを掃除して完了ページへ
    ['buyer','ordersDraft','startAt','editIndex','buyerEdit','addNew','orderType']
      .forEach(k => sessionStorage.removeItem(k));

    // サンクスページが無ければトップへ戻す
    try {
      location.href = 'thanks.html';
    } catch (_) {
      location.href = 'index.html';
    }
  } catch (err) {
    console.error(err);
    alert('エラー: ' + err.message);
  } finally {
    btnSubmit.disabled = false;
    btnSubmit.textContent = prevLabel;
  }
};

// 初期描画
renderBuyer();
renderAll();

  // モバイルCTA → 既存ボタンに委譲
 // 既存の goIndex はそのまま使えます
document.getElementById('btn-back').onclick = () => {
  goIndex({ startAt: 'recipient', editIndex: current });   // ★編集として戻す
};

// モバイル下部の戻るも同様に変更
const mBack = document.getElementById('m-back');
if (mBack) mBack.onclick = () => {
  goIndex({ startAt: 'recipient', editIndex: current });   // ★
};
  const mSubmit = document.getElementById('m-submit');
  if (mSubmit) mSubmit.onclick = ()=> document.getElementById('btn-submit').click();
</script>
</body>
</html>