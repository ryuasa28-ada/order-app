<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="address-autofill.js"></script> <!-- 住所自動補完用のJavaScript -->
  <title>ステップ式 注文フォーム 叩き台</title>
  <style>
    :root{
      --brand:#3c3a38;--acc:#8e8e8e;--ok:#3b82f6;--danger:#ef4444;--bg:#fafafa;
      --card:#ffffff;--ink:#222;--ink-weak:#666;--radius:14px;--shadow:0 6px 22px rgba(0,0,0,.08);
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Hiragino Kaku Gothic ProN',Meiryo,'Noto Sans JP',sans-serif}
    .app{max-width:980px;margin:24px auto;padding:0 16px 96px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    header .logo{font-weight:700;letter-spacing:.02em;color:#fff;background:var(--brand);padding:10px 14px;border-radius:10px}

    /* stepper */
    .stepper{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 20px}
    .step{
      position:relative;background:#eaeaea;color:#777;border-radius:999px;padding:12px 16px;text-align:center;font-weight:600
    }
    .step.active{background:var(--brand);color:#fff}
    .step.done{background:#4b5563;color:#fff}

    /* progress bar */
    .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 24px}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);transition:width .35s ease}

    /* card */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:14px 0}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    @media (max-width:700px){.g2{grid-template-columns:1fr}}

    label{font-size:.92rem;font-weight:600;display:block;margin:4px 2px}
    .req{font-size:.72rem;background:#fde68a;color:#92400e;border-radius:6px;padding:2px 6px;margin-right:6px}
    input,select,textarea{width:100%;box-sizing:border-box;padding:12px 14px;border:1.4px solid #d4d4d8;border-radius:10px;font:inherit;outline:none;transition:.2s}
    input:focus,select:focus,textarea:focus{border-color:var(--ok);box-shadow:0 0 0 3px rgba(59,130,246,.15)}

    /* nav buttons */
    .nav{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:10px}
    .btn{appearance:none;border:0;border-radius:999px;padding:12px 20px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-ghost{background:#f4f4f5;color:#111}

    .muted{color:var(--ink-weak);font-size:.9rem}
    .hidden{display:none}
    .right{display:flex;justify-content:flex-end}
    .sum{font-size:1.2rem;font-weight:800}
    .hr{height:1px;background:#eee;margin:8px 0}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">Takara Style</div>
      <div class="muted">サンプル / ステップ式フォーム</div>
    </header>

    <div class="stepper" id="stepper">
      <div class="step active" data-step="0">1 入力</div>
      <div class="step" data-step="1">2 送付先</div>
      <div class="step" data-step="2">3 商品</div>
      <div class="step" data-step="3">4 確認</div>
    </div>

    <div class="progress"><i id="bar"></i></div>

    <!-- step 1: 注文者情報 -->
    <section class="card step-pane" data-step="0">
      <h2>注文者情報</h2>
      <div class="right" style="margin-top:-8px;">
        <button type="button" class="btn btn-ghost" id="demo-buyer-fill">デモ入力（注文者）</button>
      </div>
      <div class="grid g2">
        <div class="g2" style="grid-column: 1 / -1;">
          <div style="grid-column: 1 / -1;">
            <label><span class="req">必須</span>氏名（16字以下）</label>
            <input id="name" name="name" maxlength="16" required />
          </div>
        </div>
        <div>
          <label><span class="req">必須</span>電話番号（ハイフン無）</label>
          <input id="phone-number" name="phone_number" inputmode="numeric" pattern="[0-9]{10,11}" placeholder="09012345678" required />
        </div>
        <div>
          <label><span class="req">必須</span>メールアドレス</label>
          <input id="email" name="email" type="email" required />
        </div>
        <div>
          <label><span class="req">必須</span>郵便番号（7桁）</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="postal-code" name="postal_code" inputmode="numeric" pattern="[0-9]{7}" placeholder="1234567" required />
            <button type="button" class="btn btn-ghost" id="address-search">住所検索</button>
          </div>
        </div>
        <div>
          <label><span class="req">必須</span>都道府県</label>
          <input id="prefecture" name="prefecture" required />
        </div>
        <div>
          <label><span class="req">必須</span>市区町村</label>
          <input id="city" name="city" required />
        </div>
        <div>
          <label><span class="req">必須</span>住所３（番地）</label>
          <input id="address-details" name="address_details" required />
        </div>
        <div>
          <label>住所４（建物名・部屋番号）</label>
          <input id="building" name="building" placeholder="マンション名・部屋番号" />
        </div>
        <div style="grid-column: 1 / -1;">
          <label>備考</label>
          <textarea id="remarks" name="remarks" placeholder="ご要望など" rows="3"></textarea>
        </div>
      </div>
      <div class="nav right">
        <button type="button" class="btn btn-primary" id="next-0">次へ →</button>
      </div>
    </section>

    <!-- step 2: 送付先 -->
    <section class="card step-pane hidden" data-step="1">
      <h2>送付先</h2>
      <div class="right" style="margin-top:-8px;">
        <button type="button" class="btn btn-ghost" id="demo-recipient-fill">デモ入力（送付先）</button>
      </div>
      <div class="grid g2">
        <div style="grid-column: 1 / -1;">
          <label><span class="req">必須</span>送り先 氏名</label>
          <input id="modal-destination-name" required />
        </div>
        <div>
          <label>送り先 電話（任意）</label>
          <input id="modal-destination-phone-number" inputmode="numeric" pattern="[0-9]{10,11}" placeholder="09012345678" />
        </div>
        <div class="right">
          <button type="button" class="btn btn-ghost" id="copy-buyer">注文者と同じ</button>
        </div>
        <div>
          <label><span class="req">必須</span>送り先 郵便番号（7桁）</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="modal-destination-postal-code" inputmode="numeric" pattern="[0-9]{7}" placeholder="1234567" required />
            <button type="button" class="btn btn-ghost" onclick="getAddress('modal-destination-postal-code','modal-destination-prefecture','modal-destination-city','modal-destination-address-details')">住所検索</button>
          </div>
        </div>
        <div>
          <label><span class="req">必須</span>送り先 都道府県</label>
          <input id="modal-destination-prefecture" required />
        </div>
        <div>
          <label><span class="req">必須</span>送り先 市区町村</label>
          <input id="modal-destination-city" required />
        </div>
        <div>
          <label><span class="req">必須</span>送り先 住所３（番地）</label>
          <input id="modal-destination-address-details" required />
        </div>
        <div>
          <label>送り先 住所４（建物名・部屋番号）</label>
          <input id="modal-destination-building" placeholder="マンション名・部屋番号" />
        </div>
      </div>
      <div class="nav">
        <button type="button" class="btn btn-ghost" id="back-1">← 戻る</button>
        <button type="button" class="btn btn-primary" id="next-1">次へ →</button>
      </div>
    </section>

    <!-- step 3: 商品 -->
    <section class="card step-pane hidden" data-step="2">
      <h2>商品</h2>
      <div class="grid g2">
        <div>
          <label><span class="req">必須</span>品種</label>
          <select id="modal-product-name" required>
            <option value="">--</option>
            <option>青島</option>
            <option>興津</option>
            <option>羽衣</option>
          </select>
        </div>
        <div>
          <label><span class="req">必須</span>等級1</label>
          <select id="modal-grade1" required>
            <option value="">--</option>
            <option>普通</option>
            <option>マルチ</option>
          </select>
        </div>
        <div>
          <label><span class="req">必須</span>等級2</label>
          <select id="modal-grade" required>
            <option value="">--</option>
            <option>A</option>
            <option>B</option>
          </select>
        </div>
        <div>
          <label>サイズ</label>
          <select id="modal-size">
            <option value="">--</option>
            <option>2S</option>
            <option>S</option>
            <option>M</option>
            <option>L</option>
          </select>
        </div>
        <div>
          <label><span class="req">必須</span>重量</label>
          <select id="modal-weight" required>
            <option value="">--</option>
            <option>5kg</option>
            <option>10kg</option>
            <option>15kg</option>
          </select>
        </div>
        <div>
          <label><span class="req">必須</span>箱数</label>
          <select id="modal-box-count" required>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
      </div>
      <div class="hr"></div>
      <div class="right">
        <div class="sum">合計: <span id="total">¥0</span></div>
        <input type="hidden" id="modal-estimated-cost" name="modal_estimated_cost" />
      </div>
      <div class="nav">
        <button type="button" class="btn btn-ghost" id="back-2">← 戻る</button>
        <button type="button" class="btn btn-primary" id="next-2">次へ →</button>
      </div>
    </section>

    <!-- step 4: 確認 -->
    <section class="card step-pane hidden" data-step="3">
      <h2>確認</h2>
      <p class="muted">入力内容を確認して送信してください。</p>
      <div id="confirm" class="grid"></div>
      <div class="nav">
        <div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="btn btn-ghost" id="back-3">← 戻る</button>
          <span class="muted" id="recipient-count"></span>
        </div>
        <div style="display:flex; gap:8px;">
          <button type="button" class="btn" id="add-more">＋ 送り先を追加</button>
          <button type="button" class="btn btn-primary" id="final-check">最終確認</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --- ステップ制御 ---
    const panes = [...document.querySelectorAll('.step-pane')];
    const steps = [...document.querySelectorAll('.stepper .step')];
    const bar = document.getElementById('bar');
    let step = 0;

    // --- 複数送り先用の状態 ---
    const MAX_RECIPIENTS = 20;
    let recipientIndex = 1;        // 何件目の送り先か（1始まり）
    const orders = [];             // {buyer:{...}, recipient:{...}, product:{...}}

    function updateRecipientStepLabel(){
      const label = recipientIndex > 1 ? `2 送付先 ${recipientIndex}` : `2 送付先`;
      const s = steps.find(el => el.dataset.step === '1');
      if (s) s.textContent = label;
      const cnt = document.getElementById('recipient-count');
      if (cnt) cnt.textContent = orders.length ? `現在 ${orders.length} 件登録済み` : '';
      const addBtn = document.getElementById('add-more');
      if (addBtn) addBtn.disabled = (orders.length >= MAX_RECIPIENTS);
    }

    function clearRecipientAndProduct(){
      ['modal-destination-name','modal-destination-phone-number','modal-destination-postal-code','modal-destination-prefecture','modal-destination-city','modal-destination-address-details','modal-destination-building']
        .forEach(id => { const el=document.getElementById(id); if (el) el.value=''; });
      ['modal-product-name','modal-grade1','modal-grade','modal-size','modal-weight','modal-box-count']
        .forEach(id => { const el=document.getElementById(id); if (el) el.value=''; });
      document.getElementById('modal-box-count').value = '1';
      recalc();
    }

    function collectBuyer(){
      return {
        name: document.getElementById('name').value,
        phone_number: document.getElementById('phone-number').value,
        email: document.getElementById('email').value,
        postal_code: document.getElementById('postal-code').value,
        prefecture: document.getElementById('prefecture').value,
        city: document.getElementById('city').value,
        address_details: document.getElementById('address-details').value,
        building: document.getElementById('building').value,
        remarks: document.getElementById('remarks') ? document.getElementById('remarks').value : ''
      };
    }

    function collectRecipient(){
      return {
        name: document.getElementById('modal-destination-name').value,
        tel:  document.getElementById('modal-destination-phone-number').value,
        zip:  document.getElementById('modal-destination-postal-code').value,
        pref: document.getElementById('modal-destination-prefecture').value,
        city: document.getElementById('modal-destination-city').value,
        addr3:document.getElementById('modal-destination-address-details').value,
        addr4:document.getElementById('modal-destination-building').value
      };
    }

    function collectProduct(){
      return {
        modal_product_name: document.getElementById('modal-product-name').value,
        modal_grade1: document.getElementById('modal-grade1').value,
        modal_grade: document.getElementById('modal-grade').value,
        modal_size:  document.getElementById('modal-size').value,
        modal_weight:document.getElementById('modal-weight').value,
        modal_box_count:   document.getElementById('modal-box-count').value,
        total: document.getElementById('total').textContent
      };
    }

    function setStep(to){
      step = Math.max(0, Math.min(panes.length-1, to));
      panes.forEach((p,i)=>p.classList.toggle('hidden', i!==step));
      steps.forEach((s,i)=>{
        s.classList.toggle('active', i===step);
        s.classList.toggle('done', i<step);
      });
      bar.style.width = (step/(panes.length-1))*100 + '%';
      try {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch(e) { window.scrollTo(0, 0); }
    }
    setStep(0);
    updateRecipientStepLabel();

    // 必須チェック（ざっくり）
    function checkStep0(){
      const ids = ['name','phone-number','email','postal-code','prefecture','city','address-details'];
      return ids.every(id => document.getElementById(id).value.trim() !== '');
    }
    function checkStep1(){
      const ids = ['modal-destination-name','modal-destination-postal-code','modal-destination-prefecture','modal-destination-city','modal-destination-address-details'];
      const filled = ids.every(id => (document.getElementById(id).value || '').trim() !== '');
      if (!filled) return false;
      const zip = (document.getElementById('modal-destination-postal-code').value || '').trim();
      return /^\d{7}$/.test(zip);
    }
    function checkStep2(){
      const ids = ['modal-product-name','modal-grade1','modal-grade','modal-weight','modal-box-count'];
      if(!ids.every(id => document.getElementById(id).value.trim() !== '')) return false;
      if(document.getElementById('modal-grade').value !== 'B' && document.getElementById('modal-size').value === '') return false;
      return true;
    }

    // 次へ／戻る
    document.getElementById('next-0').onclick = ()=>{
      if(!checkStep0()) { alert('必須項目を入力してください'); return; }
      setStep(1);
    };
    document.getElementById('back-1').onclick = ()=> setStep(0);
    document.getElementById('next-1').onclick = ()=>{
      if(!checkStep1()) { alert('送付先の必須を入力してください'); return; }
      setStep(2);
    };
    document.getElementById('back-2').onclick = ()=> setStep(1);
    document.getElementById('next-2').onclick = ()=>{
      if(!checkStep2()) { alert('商品の必須を入力してください'); return; }
      const c = document.getElementById('confirm');
      c.innerHTML = '';

      const buyer = collectBuyer();
      const recip = collectRecipient();
      const prod  = collectProduct();

      // 注文者情報
      const buyerCard = document.createElement('div');
      buyerCard.className = 'card';
      let buyerHtml = '<h3>注文者情報</h3>';
      buyerHtml += `<div><strong>氏名</strong>: <span class="muted">${buyer.name}</span></div>`;
      buyerHtml += `<div><strong>電話</strong>: <span class="muted">${buyer.phone_number}</span></div>`;
      buyerHtml += `<div><strong>メール</strong>: <span class="muted">${buyer.email}</span></div>`;
      buyerHtml += `<div><strong>住所</strong>: <span class="muted">${buyer.prefecture}${buyer.city}${buyer.address_details}${buyer.building ? ' ' + buyer.building : ''}</span></div>`;
      if (buyer.remarks && buyer.remarks.trim() !== '') {
        buyerHtml += `<div><strong>備考</strong>: <span class="muted">${buyer.remarks}</span></div>`;
      }
      buyerCard.innerHTML = buyerHtml;
      c.appendChild(buyerCard);

      // 送り先情報
      const recipCard = document.createElement('div');
      recipCard.className = 'card';
      let recipHtml = '<h3>送り先情報</h3>';
      recipHtml += `<div><strong>氏名</strong>: <span class="muted">${recip.name}</span></div>`;
      recipHtml += `<div><strong>電話</strong>: <span class="muted">${recip.tel || '-'}</span></div>`;
      recipHtml += `<div><strong>住所</strong>: <span class="muted">${recip.pref}${recip.city}${recip.addr3}${recip.addr4 ? ' ' + recip.addr4 : ''}</span></div>`;
      recipCard.innerHTML = recipHtml;
      c.appendChild(recipCard);

      // 商品情報
      const prodCard = document.createElement('div');
      prodCard.className = 'card';
      let prodHtml = '<h3>商品情報</h3>';
      prodHtml += `<div><strong>品種</strong>: <span class="muted">${prod.modal_product_name}</span></div>`;
      prodHtml += `<div><strong>等級1</strong>: <span class="muted">${prod.modal_grade1}</span></div>`;
      prodHtml += `<div><strong>等級2</strong>: <span class="muted">${prod.modal_grade}</span></div>`;
      prodHtml += `<div><strong>サイズ</strong>: <span class="muted">${prod.modal_size || '-'}</span></div>`;
      prodHtml += `<div><strong>重量</strong>: <span class="muted">${prod.modal_weight}</span></div>`;
      prodHtml += `<div><strong>箱数</strong>: <span class="muted">${prod.modal_box_count}</span></div>`;
      prodHtml += `<div><strong>合計</strong>: <span class="muted">${prod.total}</span></div>`;
      prodCard.innerHTML = prodHtml;
      c.appendChild(prodCard);

      setStep(3);
      updateRecipientStepLabel();
    };

    // B等級はサイズ無効
    document.getElementById('modal-grade').addEventListener('change', (e)=>{
      const size = document.getElementById('modal-size');
      if(e.target.value==='B'){ size.value=''; size.disabled=true; }
      else{ size.disabled=false; }
    });

    // 簡易 金額計算
    const priceMap = { '5kg': 3500, '10kg': 7000, '15kg': 10500 };
    function recalc(){
      const w = document.getElementById('modal-weight').value;
      const n = parseInt(document.getElementById('modal-box-count').value||'0',10);
      const total = (priceMap[w]||0)*n;
      document.getElementById('total').textContent =
        total.toLocaleString('ja-JP',{style:'currency',currency:'JPY',minimumFractionDigits:0});
      const hidden = document.getElementById('modal-estimated-cost');
      if(hidden) hidden.value = String(total);
    }
    ['modal-weight','modal-box-count'].forEach(id=>document.getElementById(id).addEventListener('change', recalc));
    recalc();

    // 住所検索（注文者）ボタン紐付け（address-autofill.js に getAddress がある想定）
    const addrBtn = document.getElementById('address-search');
    if (addrBtn && typeof getAddress === 'function') {
      addrBtn.addEventListener('click', () => {
        getAddress('postal-code','prefecture','city','address-details');
      });
    }

    // 確認→戻る
    document.getElementById('back-3').onclick = ()=> setStep(2);

    // 送り先を追加
    document.getElementById('add-more').addEventListener('click', ()=>{
      if (orders.length >= MAX_RECIPIENTS) { alert('追加できるのは最大20件までです'); return; }
      const buyer = collectBuyer();
      const recip = collectRecipient();
      const prod  = collectProduct();
      orders.push({buyer, recipient: recip, product: prod});
      recipientIndex = orders.length + 1;
      clearRecipientAndProduct();
      updateRecipientStepLabel();
      setStep(1);
    });

    // ===== FINAL CHECK NAVIGATION (DEMO) =====
document.getElementById('final-check').onclick = () => {
  const buyer = collectBuyer();
  const recip = collectRecipient();
  const prod  = collectProduct();
  const last  = { buyer, recipient: recip, product: prod };

  const editIndex = sessionStorage.getItem('editIndex');

  if (editIndex !== null) {
    // 既存データの差し替え
    orders[parseInt(editIndex, 10)] = last;
    sessionStorage.removeItem('editIndex');
  } else {
    // 新規追加
    if (!orders.length || JSON.stringify(orders[orders.length-1]) !== JSON.stringify(last)) {
      orders.push(last);
    }
  }

  // セッションに保存
  sessionStorage.setItem('buyer', JSON.stringify(buyer));
  sessionStorage.setItem('ordersDraft', JSON.stringify(orders));

  // 最終確認ページへ
  location.href = 'final-check.html';
};
    // ===== FINAL CHECK NAVIGATION (DEMO) =====

    // 注文者情報を送付先にコピー
    document.getElementById('copy-buyer').addEventListener('click', ()=>{
      document.getElementById('modal-destination-name').value = document.getElementById('name').value;
      document.getElementById('modal-destination-phone-number').value = document.getElementById('phone-number').value;
      document.getElementById('modal-destination-postal-code').value = document.getElementById('postal-code').value;
      document.getElementById('modal-destination-prefecture').value = document.getElementById('prefecture').value;
      document.getElementById('modal-destination-city').value = document.getElementById('city').value;
      document.getElementById('modal-destination-address-details').value = document.getElementById('address-details').value;
      document.getElementById('modal-destination-building').value = document.getElementById('building').value;
    });

    // ===== DEMO AUTO-FILL =====
    function demoFillBuyer() {
      document.getElementById('name').value = '安達 隆之介';
      document.getElementById('phone-number').value = '09042177478';
      document.getElementById('email').value = 'demo@example.com';
      document.getElementById('postal-code').value = '4328038';
      document.getElementById('prefecture').value = '静岡県';
      document.getElementById('city').value = '浜松市中央区';
      document.getElementById('address-details').value = '紅狐町中川15388-16';
      document.getElementById('building').value = 'VISTAGE 82-36';
      const rmk = document.getElementById('remarks');
      if (rmk) rmk.value = 'テスト送信です（このメモは任意）';
    }
    function demoFillRecipient() {
      document.getElementById('modal-destination-name').value = '安達 隆之介';
      document.getElementById('modal-destination-phone-number').value = '09042177478';
      document.getElementById('modal-destination-postal-code').value = '4328038';
      document.getElementById('modal-destination-prefecture').value = '静岡県';
      document.getElementById('modal-destination-city').value = '浜松市中央区';
      document.getElementById('modal-destination-address-details').value = '紅狐町中川15388-16';
      document.getElementById('modal-destination-building').value = 'VISTAGE 82-36';
    }
    const btnDemoBuyer = document.getElementById('demo-buyer-fill');
    if (btnDemoBuyer) btnDemoBuyer.addEventListener('click', demoFillBuyer);
    const btnDemoRecip = document.getElementById('demo-recipient-fill');
    if (btnDemoRecip) btnDemoRecip.addEventListener('click', demoFillRecipient);
    // ===== END DEMO AUTO-FILL =====

    // ===== 復元処理 =====
    document.addEventListener('DOMContentLoaded', () => {
      const savedBuyer  = JSON.parse(sessionStorage.getItem('buyer') || 'null');
      const savedOrders = JSON.parse(sessionStorage.getItem('ordersDraft') || '[]');
      const startAt     = sessionStorage.getItem('startAt');
      const editIndex   = sessionStorage.getItem('editIndex');

      // buyer をフォームへ反映
      if (savedBuyer) {
        const map = {
          name:'name', phone_number:'phone-number', email:'email',
          postal_code:'postal-code', prefecture:'prefecture', city:'city',
          address_details:'address-details', building:'building', remarks:'remarks'
        };
        Object.entries(map).forEach(([k,id])=>{
          if (document.getElementById(id) && savedBuyer[k] !== undefined) {
            document.getElementById(id).value = savedBuyer[k];
          }
        });
      }

      // orders を復元
      if (Array.isArray(savedOrders) && savedOrders.length) {
        orders.splice(0, orders.length, ...savedOrders);
      }

      // 編集モード or 新規追加
      if (editIndex !== null) {
        const idx = parseInt(editIndex, 10);
        const target = savedOrders[idx];
        if (target) {
          // recipient 復元
          const rmap = {
            name:'modal-destination-name',
            tel:'modal-destination-phone-number',
            zip:'modal-destination-postal-code',
            pref:'modal-destination-prefecture',
            city:'modal-destination-city',
            addr3:'modal-destination-address-details',
            addr4:'modal-destination-building'
          };
          Object.entries(rmap).forEach(([k,id])=>{
            if (document.getElementById(id) && target.recipient[k] !== undefined) {
              document.getElementById(id).value = target.recipient[k];
            }
          });

          // product 復元
          const pmap = {
            modal_product_name:'modal-product-name',
            modal_grade1:'modal-grade1',
            modal_grade:'modal-grade',
            modal_size:'modal-size',
            modal_weight:'modal-weight',
            modal_box_count:'modal-box-count'
          };
          Object.entries(pmap).forEach(([k,id])=>{
            if (document.getElementById(id) && target.product[k] !== undefined) {
              document.getElementById(id).value = target.product[k];
              document.getElementById(id).dispatchEvent(new Event('change', {bubbles:true}));
            }
          });
          recalc();
        }
        setStep(1); // recipient ステップへ
      } else if (startAt === 'recipient') {
        // 新規追加
        clearRecipientAndProduct();
        recipientIndex = savedOrders.length + 1;
        updateRecipientStepLabel();
        setStep(1);
      } else if (startAt === 'buyer') {
        setStep(0);
      }

      // 一度使ったフラグは削除（final 側で設定）
      sessionStorage.removeItem('startAt');
      sessionStorage.removeItem('editIndex');
    });
  </script>
</body>
</html>