<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="address-autofill.js"></script> <!-- 住所自動補完用のJavaScript -->
  <title>注文フォーム</title>
  <style>
    :root{
      --brand:#3c3a38;--acc:#8e8e8e;--ok:#3b82f6;--danger:#ef4444;--bg:#fafafa;
      --card:#ffffff;--ink:#222;--ink-weak:#666;--radius:14px;--shadow:0 6px 22px rgba(0,0,0,.08);
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Hiragino Kaku Gothic ProN',Meiryo,'Noto Sans JP',sans-serif}
    .app{max-width:980px;margin:24px auto;padding:0 16px 96px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    header .logo{font-weight:700;letter-spacing:.02em;color:#fff;background:var(--brand);padding:10px 14px;border-radius:10px}

    /* stepper */
    .stepper{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 20px}
    .step{
      position:relative;background:#eaeaea;color:#777;border-radius:999px;padding:12px 16px;text-align:center;font-weight:600
    }
    .step.active{background:var(--brand);color:#fff}
    .step.done{background:#4b5563;color:#fff}

    /* progress bar */
    .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 24px}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);transition:width .35s ease}

    /* card */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:14px 0}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    @media (max-width:700px){.g2{grid-template-columns:1fr}}

    label{font-size:.92rem;font-weight:600;display:block;margin:4px 2px}
    .req{font-size:.72rem;background:#fde68a;color:#92400e;border-radius:6px;padding:2px 6px;margin-right:6px}
    input,select,textarea{width:100%;box-sizing:border-box;padding:12px 14px;border:1.4px solid #d4d4d8;border-radius:10px;font:inherit;outline:none;transition:.2s}
    input:focus,select:focus,textarea:focus{border-color:var(--ok);box-shadow:0 0 0 3px rgba(59,130,246,.15)}

    /* nav buttons */
    .nav{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:10px}
    .btn{appearance:none;border:0;border-radius:999px;padding:12px 20px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-ghost{background:#f4f4f5;color:#111}

    .muted{color:var(--ink-weak);font-size:.9rem}
    .hidden{display:none}
    .right{display:flex;justify-content:flex-end}
    .sum{font-size:1.2rem;font-weight:800}
    .hr{height:1px;background:#eee;margin:8px 0}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">山本農園</div>
      <div class="muted">注文フォーム</div>
    </header>

    <div class="stepper" id="stepper">
      <div class="step active" data-step="0">1 入力</div>
      <div class="step" data-step="1">2 送付先</div>
      <div class="step" data-step="2">3 商品</div>
      <div class="step" data-step="3">4 確認</div>
    </div>

    <div class="progress"><i id="bar"></i></div>

    <!-- step 1: 注文者情報 -->
    <section class="card step-pane" data-step="0">
      <h2>注文者情報</h2>
      <div class="right" style="margin-top:-8px;">
        <button type="button" class="btn btn-ghost" id="demo-buyer-fill">デモ入力（注文者）</button>
      </div>

      <!-- 将来PHPで使うtypeも保持（既存仕様踏襲） -->
      <input type="hidden" name="type" value="<?php echo htmlspecialchars($_GET['type'] ?? 'NL'); ?>">

      <div class="grid g2">
        <div class="g2" style="grid-column: 1 / -1;">
          <div style="grid-column: 1 / -1;">
            <label for="name"><span class="req">必須</span>氏名（16字以下）</label>
            <input id="name" name="name" maxlength="16" required autocomplete="name" />
          </div>
        </div>

        <div>
          <label for="phone-number"><span class="req">必須</span>電話番号（ハイフン無）</label>
          <input id="phone-number" name="phone_number"
            inputmode="numeric" maxlength="11"
            pattern="^\d{10,11}$"
            title="半角数字10〜11桁で入力してください"
            placeholder="09012345678"
            oninput="enforceDigits(this, 11)" required />
        </div>

        <div>
          <label for="email"><span class="req">必須</span>メールアドレス</label>
          <input id="email" name="email" type="email" inputmode="email"
            spellcheck="false" autocapitalize="off" autocomplete="email"
            pattern="^[A-Za-z0-9._%+\-]+@[A-Za-z0-9.\-]+\.[A-Za-z]{2,}$"
            title="半角英数字のメールアドレスを入力してください"
            oninput="normalizeEmail(this)" required />
        </div>

        <div>
          <label for="postal-code"><span class="req">必須</span>郵便番号（7桁）</label>
          <input id="postal-code" name="postal_code"
            inputmode="numeric" maxlength="7"
            pattern="^\d{7}$"
            title="半角数字7桁で入力してください"
            placeholder="1234567"
            oninput="enforceDigits(this, 7)" required autocomplete="postal-code" />
          <button type="button" class="btn btn-ghost" id="address-search">住所検索</button>
        </div>

        <div>
          <label for="prefecture"><span class="req">必須</span>都道府県</label>
          <input id="prefecture" name="prefecture" required />
        </div>

        <div>
          <label for="city"><span class="req">必須</span>市区町村</label>
          <input id="city" name="city" required />
        </div>

        <div>
          <label for="address-details"><span class="req">必須</span>住所３（番地）</label>
          <input id="address-details" name="address_details" required />
        </div>

        <div>
          <label for="building">住所４（建物名・部屋番号）</label>
          <input id="building" name="building" maxlength="16" placeholder="マンション名・部屋番号" />
        </div>

        <div style="grid-column: 1 / -1;">
          <label for="remarks">備考</label>
          <textarea id="remarks" name="remarks" maxlength="2000"
            placeholder="ご要望など" rows="3"></textarea>
        </div>
      </div>

      <div class="nav right">
        <button type="button" class="btn btn-primary" id="next-0">次へ →</button>
      </div>
    </section>

    <!-- step 2: 送付先 -->
    <section class="card step-pane hidden" data-step="1">
      <h2>送付先</h2>
      <div class="right" style="margin-top:-8px;">
        <button type="button" class="btn btn-ghost" id="demo-recipient-fill">デモ入力（送付先）</button>
      </div>

      <div class="grid g2">
        <div style="grid-column: 1 / -1;">
          <label for="modal-destination-name"><span class="req">必須</span>送り先 氏名</label>
          <input id="modal-destination-name" name="destination_name[]" maxlength="16" required />
        </div>

        <div>
          <label for="modal-destination-phone-number">送り先 電話（注文者でも可）</label>
          <input id="modal-destination-phone-number" name="destination_phone_number[]"
            inputmode="numeric" maxlength="11"
            pattern="^\d{10,11}$"
            title="半角数字10〜11桁で入力してください"
            placeholder="09012345678"
            oninput="enforceDigits(this, 11)" />
        </div>

        <div class="right">
          <button type="button" class="btn btn-ghost" id="copy-buyer">注文者と同じ</button>
        </div>

        <div>
          <label for="modal-destination-postal-code"><span class="req">必須</span>送り先 郵便番号（7桁）</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="modal-destination-postal-code" name="destination_postal_code[]"
              inputmode="numeric" maxlength="7"
              pattern="^\d{7}$"
              title="半角数字7桁で入力してください"
              placeholder="1234567"
              oninput="enforceDigits(this, 7)" required />
            <button type="button" class="btn btn-ghost"
              onclick="getAddress('modal-destination-postal-code','modal-destination-prefecture','modal-destination-city','modal-destination-address-details')">
              住所検索
            </button>
          </div>
        </div>

        <div>
          <label for="modal-destination-prefecture"><span class="req">必須</span>送り先 都道府県</label>
          <input id="modal-destination-prefecture" name="destination_prefecture[]" required />
        </div>

        <div>
          <label for="modal-destination-city"><span class="req">必須</span>送り先 市区町村</label>
          <input id="modal-destination-city" name="destination_city[]" required />
        </div>

        <div>
          <label for="modal-destination-address-details"><span class="req">必須</span>送り先 住所３（番地）</label>
          <input id="modal-destination-address-details" name="destination_address_details[]" required />
        </div>

        <div>
          <label for="modal-destination-building">送り先 住所４（建物名・部屋番号）</label>
          <input id="modal-destination-building" name="destination_building[]" maxlength="16" placeholder="マンション名・部屋番号" />
        </div>
      </div>

      <div class="nav">
        <button type="button" class="btn btn-ghost" id="back-1">← 戻る</button>
        <button type="button" class="btn btn-primary" id="next-1">次へ →</button>
      </div>
    </section>

    <!-- step 3: 商品（旧バージョン相当の動的構造に変更） -->
    <section class="card step-pane hidden" data-step="2">
      <h2>商品</h2>

      <div class="grid g2">
        <!-- 品種（DBから動的取得） -->
        <div>
          <label for="modal-product-name"><span class="req">必須</span>品種</label>
          <select id="modal-product-name" name="product_name[]" required autocomplete="off">
            <option value="">--</option>
            <?php
            // 旧版と同等：販売期間内の品種を取得して表示
            require_once 'db_config.php'; // DB接続設定
            $current_date = date('Y-m-d');

            $query = "
                SELECT DISTINCT ITMNM
                FROM MT_ItemMaster
                WHERE STDATE <= ? AND EDDATE >= ?
            ";
            $stmt = $conn->prepare($query);
            $stmt->bind_param("ss", $current_date, $current_date);
            $stmt->execute();
            $result = $stmt->get_result();

            if ($result && $result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    $nm = htmlspecialchars($row['ITMNM']);
                    echo "<option value=\"{$nm}\">{$nm}</option>";
                }
            } else {
                echo '<option value="">利用可能な品種がありません</option>';
            }

            $stmt->close();
            $conn->close();
            ?>
          </select>
        </div>

        <!-- 等級1（動的に埋める） -->
        <div>
          <label for="modal-grade1"><span class="req">必須</span>等級1</label>
          <select id="modal-grade1" name="grade1[]" required autocomplete="off" disabled>
            <option value="">--</option>
          </select>
        </div>

        <!-- 等級2（動的） -->
        <div>
          <label for="modal-grade"><span class="req">必須</span>等級2</label>
          <select id="modal-grade" name="grade[]" required autocomplete="off" disabled>
            <option value="">--</option>
          </select>
        </div>

        <!-- サイズ（動的 / B等級のときはJSで無効化） -->
        <div>
          <label for="modal-size">サイズ</label>
          <select id="modal-size" name="size[]" autocomplete="off" disabled>
            <option value="">--</option>
          </select>
        </div>

        <!-- 重量（動的） -->
        <div>
          <label for="modal-weight"><span class="req">必須</span>重量</label>
          <select id="modal-weight" name="weight[]" required autocomplete="off" disabled>
            <option value="">--</option>
          </select>
        </div>

        <!-- 箱数（重量に応じて動的） -->
        <div>
          <label for="modal-box-count"><span class="req">必須</span>箱数</label>
          <select id="modal-box-count" name="box_count[]" required autocomplete="off" disabled>
            <option value="">--</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>
      <div class="right">
        <div class="sum">合計（送料別）: <span id="total">¥0</span></div>
        <!-- 合計は旧仕様互換の estimated_cost[] で保持 -->
        <input type="hidden" id="modal-estimated-cost" name="estimated_cost[]" />
      </div>

      <div class="nav">
        <button type="button" class="btn btn-ghost" id="back-2">← 戻る</button>
        <button type="button" class="btn btn-primary" id="next-2">次へ →</button>
      </div>
    </section>

    <!-- step 4: 確認 -->
    <section class="card step-pane hidden" data-step="3">
      <h2>確認</h2>
      <p class="muted">入力内容を確認して送信してください。</p>

      <div id="confirm" class="grid"></div>

      <div class="nav">
        <div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="btn btn-ghost" id="back-3">← 戻る</button>
          <span class="muted" id="recipient-count"></span>
        </div>
        <div style="display:flex; gap:8px;">
          <button type="button" class="btn" id="add-more">＋ 送り先を追加</button>
          <button type="button" class="btn btn-primary" id="final-check">最終確認</button>
        </div>
      </div>
    </section>
  </div>
  <script>
  // === 共通ユーティリティ（未定義参照の補完） ===
  function enforceDigits(el, max) {
    if (!el) return;
    el.value = (el.value || '').replace(/\D+/g, '').slice(0, max || 999);
  }
  function normalizeEmail(el) {
    if (!el) return;
    el.value = (el.value || '').trim();
  }

  // --- ステップ制御 ---
  const panes = [...document.querySelectorAll('.step-pane')];
  const steps = [...document.querySelectorAll('.stepper .step')];
  const bar = document.getElementById('bar');
  let step = 0;

  const MAX_RECIPIENTS = 20;
  let recipientIndex = 1;
  const orders = [];

  // ★ 編集モード判定
  const EDIT_INDEX = sessionStorage.getItem('editIndex');
  const EDIT_MODE  = EDIT_INDEX !== null;

  function updateRecipientStepLabel(){
    const label = recipientIndex > 1 ? `2 送付先 ${recipientIndex}` : `2 送付先`;
    const s = steps.find(el => el.dataset.step === '1');
    if (s) s.textContent = label;
    const cnt = document.getElementById('recipient-count');
    if (cnt) cnt.textContent = orders.length ? `現在 ${orders.length} 件登録済み` : '';
    const addBtn = document.getElementById('add-more');
    if (addBtn) addBtn.disabled = (orders.length >= MAX_RECIPIENTS);
  }

  function clearRecipientAndProduct(){
    ['modal-destination-name','modal-destination-phone-number','modal-destination-postal-code','modal-destination-prefecture','modal-destination-city','modal-destination-address-details','modal-destination-building']
      .forEach(id => { const el=document.getElementById(id); if (el) el.value=''; });

    // 商品は段階制御に合わせてリセット
    ['modal-product-name','modal-grade1','modal-grade','modal-size','modal-weight','modal-box-count']
      .forEach(id => { const el=document.getElementById(id); if (el) el.value=''; });

    // 初期は箱数を '--' に、重量未選択なら '--'
    updateBoxCountOptions('', document.getElementById('modal-box-count'));
    document.getElementById('total').textContent = '¥0';
    const hidden = document.getElementById('modal-estimated-cost');
    if (hidden) hidden.value = '0';

    // セレクトの活性制御を初期化
    initProductSelectsDisabled();
  }

  function collectBuyer(){
    return {
      name: document.getElementById('name').value,
      phone_number: document.getElementById('phone-number').value,
      email: document.getElementById('email').value,
      postal_code: document.getElementById('postal-code').value,
      prefecture: document.getElementById('prefecture').value,
      city: document.getElementById('city').value,
      address_details: document.getElementById('address-details').value,
      building: document.getElementById('building').value,
      remarks: document.getElementById('remarks') ? document.getElementById('remarks').value : ''
    };
  }

  function collectRecipient(){
    return {
      name: document.getElementById('modal-destination-name').value,
      tel:  document.getElementById('modal-destination-phone-number').value,
      zip:  document.getElementById('modal-destination-postal-code').value,
      pref: document.getElementById('modal-destination-prefecture').value,
      city: document.getElementById('modal-destination-city').value,
      addr3:document.getElementById('modal-destination-address-details').value,
      addr4:document.getElementById('modal-destination-building').value
    };
  }

  function collectProduct(){
    return {
      modal_product_name: document.getElementById('modal-product-name').value,
      modal_grade1: document.getElementById('modal-grade1').value,
      modal_grade: document.getElementById('modal-grade').value,
      modal_size:  document.getElementById('modal-size').value,
      modal_weight:document.getElementById('modal-weight').value,
      modal_box_count:   document.getElementById('modal-box-count').value,
      total: document.getElementById('total').textContent
    };
  }

  function setStep(to){
    step = Math.max(0, Math.min(panes.length-1, to));
    panes.forEach((p,i)=>p.classList.toggle('hidden', i!==step));
    steps.forEach((s,i)=>{
      s.classList.toggle('active', i===step);
      s.classList.toggle('done', i<step);
    });
    bar.style.width = (step/(panes.length-1))*100 + '%';
    try {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch(e) { window.scrollTo(0, 0); }
  }
  setStep(0);
  updateRecipientStepLabel();

  // 必須チェック（ざっくり）
  function checkStep0(){
    const ids = ['name','phone-number','email','postal-code','prefecture','city','address-details'];
    return ids.every(id => (document.getElementById(id).value || '').trim() !== '');
  }
  function checkStep1(){
    const ids = ['modal-destination-name','modal-destination-postal-code','modal-destination-prefecture','modal-destination-city','modal-destination-address-details'];
    const filled = ids.every(id => (document.getElementById(id).value || '').trim() !== '');
    if (!filled) return false;
    const zip = (document.getElementById('modal-destination-postal-code').value || '').trim();
    return /^\d{7}$/.test(zip);
  }
  function checkStep2(){
    const ids = ['modal-product-name','modal-grade1','modal-grade','modal-weight','modal-box-count'];
    if(!ids.every(id => (document.getElementById(id).value || '').trim() !== '')) return false;
    if(document.getElementById('modal-grade').value !== 'B' && document.getElementById('modal-size').value === '') return false;
    return true;
  }

  // 次へ／戻る
  document.getElementById('next-0').onclick = ()=>{
    if(!checkStep0()) { alert('必須項目を入力してください'); return; }

    if (sessionStorage.getItem('buyerEdit')) {
      // ★ 全ての送り先に buyer 情報を反映
      const buyer = collectBuyer();
      orders.forEach((o, i)=> { orders[i].buyer = buyer; });
      sessionStorage.setItem('buyer', JSON.stringify(buyer));
      sessionStorage.setItem('ordersDraft', JSON.stringify(orders));
      sessionStorage.removeItem('buyerEdit'); // 編集完了フラグを消す
      location.href = 'final-check.html'; // 最終確認へ直行
    } else {
      setStep(1); // 通常モード
    }
  };
  document.getElementById('back-1').onclick = ()=> setStep(0);
  document.getElementById('back-2').onclick = ()=> setStep(1);

  // ---- 送付先の次へ ----
  document.getElementById('next-1').onclick = ()=>{
    if(!checkStep1()) { alert('送付先の必須を入力してください'); return; }
    setStep(2);
  };

  // ---- 商品の次へ ----
  document.getElementById('next-2').onclick = async ()=>{
    if(!checkStep2()) { alert('商品の必須を入力してください'); return; }

    if (EDIT_MODE) {
      upsertAndGoFinal();
      return;
    }

    // （通常モードのみ：確認カードを作ってステップ4へ）
    const c = document.getElementById('confirm');
    c.innerHTML = '';

    const buyer = collectBuyer();
    const recip = collectRecipient();
    const prod  = collectProduct();

    const buyerCard = document.createElement('div');
    buyerCard.className = 'card';
    let buyerHtml = '<h3>注文者情報</h3>';
    buyerHtml += `<div><strong>氏名</strong>: <span class="muted">${buyer.name}</span></div>`;
    buyerHtml += `<div><strong>電話</strong>: <span class="muted">${buyer.phone_number}</span></div>`;
    buyerHtml += `<div><strong>メール</strong>: <span class="muted">${buyer.email}</span></div>`;
    buyerHtml += `<div><strong>住所</strong>: <span class="muted">${buyer.prefecture}${buyer.city}${buyer.address_details}${buyer.building ? ' ' + buyer.building : ''}</span></div>`;
    if (buyer.remarks && buyer.remarks.trim() !== '') {
      buyerHtml += `<div><strong>備考</strong>: <span class="muted">${buyer.remarks}</span></div>`;
    }
    buyerCard.innerHTML = buyerHtml;
    c.appendChild(buyerCard);

    const recipCard = document.createElement('div');
    recipCard.className = 'card';
    let recipHtml = '<h3>送り先情報</h3>';
    recipHtml += `<div><strong>氏名</strong>: <span class="muted">${recip.name}</span></div>`;
    recipHtml += `<div><strong>電話</strong>: <span class="muted">${recip.tel || '-'}</span></div>`;
    recipHtml += `<div><strong>住所</strong>: <span class="muted">${recip.pref}${recip.city}${recip.addr3}${recip.addr4 ? ' ' + recip.addr4 : ''}</span></div>`;
    recipCard.innerHTML = recipHtml;
    c.appendChild(recipCard);

    const prodCard = document.createElement('div');
    prodCard.className = 'card';
    let prodHtml = '<h3>商品情報</h3>';
    prodHtml += `<div><strong>品種</strong>: <span class="muted">${prod.modal_product_name}</span></div>`;
    prodHtml += `<div><strong>等級1</strong>: <span class="muted">${prod.modal_grade1}</span></div>`;
    prodHtml += `<div><strong>等級2</strong>: <span class="muted">${prod.modal_grade}</span></div>`;
    prodHtml += `<div><strong>サイズ</strong>: <span class="muted">${prod.modal_size || '-'}</span></div>`;
    prodHtml += `<div><strong>重量</strong>: <span class="muted">${prod.modal_weight}</span></div>`;
    prodHtml += `<div><strong>箱数</strong>: <span class="muted">${prod.modal_box_count}</span></div>`;
    prodHtml += `<div><strong>合計</strong>: <span class="muted">${prod.total}</span></div>`;
    prodCard.innerHTML = prodHtml;
    c.appendChild(prodCard);

    setStep(3);
    updateRecipientStepLabel();
  };

  // ====== 旧タイプ相当：商品セレクトの段階制御 ======
  function fillSelect(selectEl, options) {
    if (!selectEl) return;
    const cur = selectEl.value;
    selectEl.innerHTML = '<option value="">--</option>';
    (options || []).forEach(v => selectEl.appendChild(new Option(v, v)));
    // 既存値が候補にあれば維持
    if (options && options.includes(cur)) selectEl.value = cur;
  }
  function enableSelect(selectEl, enabled) {
    if (!selectEl) return;
    selectEl.disabled = !enabled;
    if (!enabled) selectEl.value = '';
  }
  function resetAfter(stepIndex) {
    // 0: 品種, 1: 等級1, 2: 等級2, 3: サイズ, 4: 重量
    const seq = [
      document.getElementById('modal-product-name'),
      document.getElementById('modal-grade1'),
      document.getElementById('modal-grade'),
      document.getElementById('modal-size'),
      document.getElementById('modal-weight'),
    ];
    for (let i = stepIndex; i < seq.length; i++) {
      if (!seq[i]) continue;
      enableSelect(seq[i], false);
      fillSelect(seq[i], []);
    }
    // 箱数もクリア
    updateBoxCountOptions('', document.getElementById('modal-box-count'));
    recalc();
  }
  function initProductSelectsDisabled() {
    // 初期状態：品種のみ有効、以降は無効
    enableSelect(document.getElementById('modal-product-name'), true);
    ['modal-grade1','modal-grade','modal-size','modal-weight','modal-box-count'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (id==='modal-box-count') {
        updateBoxCountOptions('', el); // '--' のみに
        el.disabled = true;
      } else {
        el.disabled = true;
        fillSelect(el, []);
      }
    });
  }

  async function fetchNextOptions(count, payload) {
    const fd = new FormData();
    fd.append('count', String(count));
    Object.entries(payload).forEach(([k, v]) => v && fd.append(k, v));
    const res = await fetch('fetch_options.php', { method: 'POST', body: fd });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || '候補取得失敗');
    return data.options || [];
  }

  function updateBoxCountOptions(weight, boxCountSelect) {
    if (!boxCountSelect) return;
    boxCountSelect.innerHTML = '';
    let max = 0;
    if (weight === '5kg' || weight === '10kg') max = 2;
    else if (weight === '15kg') max = 1;

    if (max === 0) {
      boxCountSelect.appendChild(new Option('--', ''));
      boxCountSelect.disabled = true;
    } else {
      for (let i=1;i<=max;i++) boxCountSelect.appendChild(new Option(i, String(i)));
      boxCountSelect.disabled = false;
      if (!boxCountSelect.value) boxCountSelect.value = '1';
    }
  }

  // B等級はサイズ無効
  document.getElementById('modal-grade').addEventListener('change', (e)=>{
    const size = document.getElementById('modal-size');
    if(e.target.value==='B'){ size.value=''; size.disabled=true; }
    else{ size.disabled=false; }
  });

  // 簡易 金額計算（fetch_item_value.php を呼んだ単価×箱数）
  const priceMapFallback = { '5kg': 3500, '10kg': 7000, '15kg': 10500 }; // フォールバック
  async function fetchPriceAndRecalc() {
    const productName = document.getElementById('modal-product-name').value;
    const grade1 = document.getElementById('modal-grade1').value;
    const grade2 = document.getElementById('modal-grade').value;
    const size   = document.getElementById('modal-size').value;
    const weight = document.getElementById('modal-weight').value;
    const box    = document.getElementById('modal-box-count').value;

    // 必須が揃っていないなら 0 表示
    if (!productName || !grade1 || !grade2 || !weight || !box || (grade2!=='B' && !size)) {
      document.getElementById('total').textContent = '¥0';
      const hidden = document.getElementById('modal-estimated-cost');
      if (hidden) hidden.value = '0';
      return;
    }

    try {
      const fd = new FormData();
      fd.append('product_name', productName);
      fd.append('grade1', grade1);
      fd.append('grade2', grade2);
      if (grade2 !== 'B') fd.append('size', size);
      fd.append('weight', weight);
      const res = await fetch('fetch_item_value.php', { method:'POST', body: fd });
      const data = await res.json();

      let unit = 0;
      if (data && data.success) {
        unit = Number(data.value) || 0;
      } else {
        // フォールバック（サンプル価格表）
        unit = priceMapFallback[weight] || 0;
      }

      const total = unit * Number(box || 0);
      document.getElementById('total').textContent =
        total.toLocaleString('ja-JP',{style:'currency',currency:'JPY',minimumFractionDigits:0});
      const hidden = document.getElementById('modal-estimated-cost');
      if (hidden) hidden.value = String(total);
    } catch (e) {
      // 通信エラー時もフォールバック
      const unit = priceMapFallback[weight] || 0;
      const total = unit * Number(box || 0);
      document.getElementById('total').textContent =
        total.toLocaleString('ja-JP',{style:'currency',currency:'JPY',minimumFractionDigits:0});
      const hidden = document.getElementById('modal-estimated-cost');
      if (hidden) hidden.value = String(total);
    }
  }
  function recalc(){ fetchPriceAndRecalc(); }

  // ----- カスケード連携（step3） -----
  function setupCascadingProductStep() {
    const selITM  = document.getElementById('modal-product-name');
    const selR1   = document.getElementById('modal-grade1');
    const selR2   = document.getElementById('modal-grade');
    const selSIZE = document.getElementById('modal-size');
    const selW    = document.getElementById('modal-weight');
    const selBOX  = document.getElementById('modal-box-count');

    if (!selITM || !selR1 || !selR2 || !selSIZE || !selW || !selBOX) return;

    // 初期状態
    initProductSelectsDisabled();

    // 品種 → 等級1
    selITM.addEventListener('change', async function() {
      resetAfter(1);
      if (!this.value) { recalc(); return; }
      try {
        const opts = await fetchNextOptions(2, { itmnm: this.value });
        fillSelect(selR1, opts);
        enableSelect(selR1, true);
      } catch (e) { alert(e.message || '等級1の取得に失敗しました'); }
      recalc();
    });

    // 等級1 → 等級2
    selR1.addEventListener('change', async function() {
      resetAfter(2);
      if (!this.value || !selITM.value) { recalc(); return; }
      try {
        const opts = await fetchNextOptions(3, { itmnm: selITM.value, rank1: this.value });
        fillSelect(selR2, opts);
        enableSelect(selR2, true);
      } catch (e) { alert(e.message || '等級2の取得に失敗しました'); }
      recalc();
    });

    // 等級2 → サイズ
    selR2.addEventListener('change', async function() {
      resetAfter(3);
      if (!this.value || !selITM.value || !selR1.value) { recalc(); return; }
      try {
        const opts = await fetchNextOptions(4, { itmnm: selITM.value, rank1: selR1.value, rank2: this.value });
        fillSelect(selSIZE, opts);
        // B 等級ならサイズ無効（旧仕様）
        if (this.value === 'B' && (!opts || opts.length === 0)) {
          enableSelect(selSIZE, false);
        } else {
          enableSelect(selSIZE, this.value !== 'B'); // Bの時は基本無効
        }
        // Bの時は即、重量を取得可能に
        if (this.value === 'B') {
          // サイズ未選択でも進める仕様のため、weight 候補を取って活性化
          try {
            const wopts = await fetchNextOptions(5, { itmnm: selITM.value, rank1: selR1.value, rank2: this.value });
            fillSelect(selW, wopts);
            enableSelect(selW, true);
          } catch (e) { /* 無視 */ }
        }
      } catch (e) { alert(e.message || 'サイズの取得に失敗しました'); }
      recalc();
    });

    // サイズ → 重量
    selSIZE.addEventListener('change', async function() {
      // B 等級はサイズが不要だが、A では必須
      resetAfter(4);
      if ((!this.value && selR2.value !== 'B') || !selITM.value || !selR1.value || !selR2.value) { recalc(); return; }
      try {
        const payload = { itmnm: selITM.value, rank1: selR1.value, rank2: selR2.value };
        if (selR2.value !== 'B') payload.size = this.value;
        const opts = await fetchNextOptions(5, payload);
        fillSelect(selW, opts);
        enableSelect(selW, true);
      } catch (e) { alert(e.message || '重量の取得に失敗しました'); }
      recalc();
    });

    // 重量 → 箱数
    selW.addEventListener('change', function() {
      updateBoxCountOptions(this.value, selBOX);
      recalc();
    });

    // 箱数変更 → 金額再計算
    selBOX.addEventListener('change', recalc);
  }

  // 住所検索（注文者）ボタン紐付け（address-autofill.js に getAddress がある想定）
  const addrBtn = document.getElementById('address-search');
  if (addrBtn && typeof getAddress === 'function') {
    addrBtn.addEventListener('click', () => {
      getAddress('postal-code','prefecture','city','address-details');
    });
  }

  // 確認→戻る
  document.getElementById('back-3').onclick = ()=> setStep(2);

  // 送り先を追加
  document.getElementById('add-more').addEventListener('click', ()=>{
    if (orders.length >= MAX_RECIPIENTS) { alert('追加できるのは最大20件までです'); return; }
    const buyer = collectBuyer();
    const recip = collectRecipient();
    const prod  = collectProduct();
    orders.push({buyer, recipient: recip, product: prod});
    recipientIndex = orders.length + 1;
    clearRecipientAndProduct();
    updateRecipientStepLabel();
    setStep(1);
  });

  // ===== FINAL CHECK NAVIGATION =====
  document.getElementById('final-check').onclick = () => { upsertAndGoFinal(); };

  // 追加：セッションフラグの取得
  const ADD_NEW   = sessionStorage.getItem('addNew') === 'true';
  const EDIT_IDX  = sessionStorage.getItem('editIndex'); // '0'.. or null

  function upsertAndGoFinal() {
    const buyer = collectBuyer();
    const recip = collectRecipient();
    const prod  = collectProduct();
    const last  = { buyer, recipient: recip, product: prod };

    let writeIndex = null;
    if (EDIT_IDX !== null) {
      writeIndex = parseInt(EDIT_IDX, 10);
    } else if (ADD_NEW) {
      writeIndex = orders.length;           // 末尾に新規
    } else if (orders.length > 0) {
      writeIndex = orders.length - 1;
    } else {
      writeIndex = 0;
    }

    if (writeIndex < orders.length) { orders[writeIndex] = last; }
    else { orders.push(last); }

    sessionStorage.setItem('buyer', JSON.stringify(buyer));
    sessionStorage.setItem('ordersDraft', JSON.stringify(orders));
    sessionStorage.removeItem('editIndex');
    sessionStorage.removeItem('addNew');

    location.href = 'final-check.html';
  }

  // 注文者情報を送付先にコピー
  document.getElementById('copy-buyer').addEventListener('click', ()=>{
    document.getElementById('modal-destination-name').value = document.getElementById('name').value;
    document.getElementById('modal-destination-phone-number').value = document.getElementById('phone-number').value;
    document.getElementById('modal-destination-postal-code').value = document.getElementById('postal-code').value;
    document.getElementById('modal-destination-prefecture').value = document.getElementById('prefecture').value;
    document.getElementById('modal-destination-city').value = document.getElementById('city').value;
    document.getElementById('modal-destination-address-details').value = document.getElementById('address-details').value;
    document.getElementById('modal-destination-building').value = document.getElementById('building').value;
  });

  // ===== DEMO AUTO-FILL =====
  function demoFillBuyer() {
    document.getElementById('name').value = '安達 隆之介';
    document.getElementById('phone-number').value = '09042177478';
    document.getElementById('email').value = 'demo@example.com';
    document.getElementById('postal-code').value = '4328038';
    document.getElementById('prefecture').value = '静岡県';
    document.getElementById('city').value = '浜松市中央区';
    document.getElementById('address-details').value = '紅狐町中川15388-16';
    document.getElementById('building').value = 'VISTAGE 82-36';
    const rmk = document.getElementById('remarks');
    if (rmk) rmk.value = 'テスト送信です（このメモは任意）';
  }
  function demoFillRecipient() {
    document.getElementById('modal-destination-name').value = '安達 隆之介';
    document.getElementById('modal-destination-phone-number').value = '09042177478';
    document.getElementById('modal-destination-postal-code').value = '4328038';
    document.getElementById('modal-destination-prefecture').value = '静岡県';
    document.getElementById('modal-destination-city').value = '浜松市中央区';
    document.getElementById('modal-destination-address-details').value = '紅狐町中川15388-16';
    document.getElementById('modal-destination-building').value = 'VISTAGE 82-36';
  }
  const btnDemoBuyer = document.getElementById('demo-buyer-fill');
  if (btnDemoBuyer) btnDemoBuyer.addEventListener('click', demoFillBuyer);
  const btnDemoRecip = document.getElementById('demo-recipient-fill');
  if (btnDemoRecip) btnDemoRecip.addEventListener('click', demoFillRecipient);
  // ===== END DEMO AUTO-FILL =====

  // ===== 復元処理（置き換え版＋商品段階復元対応） =====
  (function () {
    const readJSON = (key, fallback) => {
      try { const raw = sessionStorage.getItem(key); return raw === null ? fallback : JSON.parse(raw); }
      catch { return fallback; }
    };
    const readFlag = (key) => sessionStorage.getItem(key) === 'true';
    const clearOnce = (...keys) => keys.forEach(k => sessionStorage.removeItem(k));

    document.addEventListener('DOMContentLoaded', async () => {
      // 商品段階制御の初期セット
      setupCascadingProductStep();

      const savedBuyer   = readJSON('buyer', null);
      const savedOrders  = readJSON('ordersDraft', []);
      const startAt      = sessionStorage.getItem('startAt');   // 'buyer' | 'recipient' | null
      const editIndexStr = sessionStorage.getItem('editIndex'); // '0','1',… | null
      const addNew       = readFlag('addNew');                  // 任意フラグ

      // --- buyer をフォームへ ---
      if (savedBuyer) {
        const map = {
          name:'name', phone_number:'phone-number', email:'email',
          postal_code:'postal-code', prefecture:'prefecture', city:'city',
          address_details:'address-details', building:'building', remarks:'remarks'
        };
        Object.entries(map).forEach(([k,id]) => {
          const el = document.getElementById(id);
          if (el && savedBuyer[k] !== undefined) el.value = savedBuyer[k];
        });
      }

      // --- orders を復元 ---
      if (Array.isArray(savedOrders)) {
        orders.splice(0, orders.length, ...savedOrders);
      } else {
        orders.splice(0, orders.length); // 壊れていた場合は空に
      }

      // --- 編集モード or 新規追加 or 既定 ---
      const hasEdit = editIndexStr !== null && !Number.isNaN(+editIndexStr);

      // 商品・送付先の復元（段階フェッチして値を注入）
      async function restoreRecipientAndProductFrom(target) {
        if (!target) return;

        // recipient 復元
        const rmap = {
          name:'modal-destination-name',
          tel:'modal-destination-phone-number',
          zip:'modal-destination-postal-code',
          pref:'modal-destination-prefecture',
          city:'modal-destination-city',
          addr3:'modal-destination-address-details',
          addr4:'modal-destination-building'
        };
        Object.entries(rmap).forEach(([k,id]) => {
          const el = document.getElementById(id);
          if (el && target.recipient && target.recipient[k] !== undefined) el.value = target.recipient[k];
        });

        // product 復元（依存チェーンを順にフェッチ）
        const p = target.product || {};
        const selITM  = document.getElementById('modal-product-name');
        const selR1   = document.getElementById('modal-grade1');
        const selR2   = document.getElementById('modal-grade');
        const selSIZE = document.getElementById('modal-size');
        const selW    = document.getElementById('modal-weight');
        const selBOX  = document.getElementById('modal-box-count');

        // 品種
        if (p.modal_product_name) {
          selITM.value = p.modal_product_name;
          selITM.dispatchEvent(new Event('change', { bubbles:true }));
          // 等級1
          try {
            const opts1 = await fetchNextOptions(2, { itmnm: p.modal_product_name });
            fillSelect(selR1, opts1); enableSelect(selR1, true);
            if (opts1.includes(p.modal_grade1)) selR1.value = p.modal_grade1;
          } catch {}

          // 等級2
          if (selR1.value) {
            try {
              const opts2 = await fetchNextOptions(3, { itmnm: p.modal_product_name, rank1: selR1.value });
              fillSelect(selR2, opts2); enableSelect(selR2, true);
              if (opts2.includes(p.modal_grade)) selR2.value = p.modal_grade;
            } catch {}
          }

          // サイズ
          if (selR2.value) {
            try {
              const payload4 = { itmnm: p.modal_product_name, rank1: selR1.value, rank2: selR2.value };
              const opts4 = await fetchNextOptions(4, payload4);
              fillSelect(selSIZE, opts4);
              if (selR2.value === 'B') {
                enableSelect(selSIZE, false);
              } else {
                enableSelect(selSIZE, true);
                if (opts4.includes(p.modal_size)) selSIZE.value = p.modal_size;
              }
            } catch {}
          }

          // 重量
          try {
            const payload5 = { itmnm: p.modal_product_name, rank1: selR1.value, rank2: selR2.value };
            if (selR2.value !== 'B' && p.modal_size) payload5.size = p.modal_size;
            const opts5 = await fetchNextOptions(5, payload5);
            fillSelect(selW, opts5); enableSelect(selW, true);
            if (opts5.includes(p.modal_weight)) selW.value = p.modal_weight;
          } catch {}

          // 箱数
          updateBoxCountOptions(selW.value, selBOX);
          if (selBOX.querySelector(`option[value="${p.modal_box_count}"]`)) {
            selBOX.value = p.modal_box_count;
          }
          recalc();
        }
      }

      if (hasEdit) {
        const idx = Math.max(0, Math.min(+editIndexStr, savedOrders.length - 1));
        const target = savedOrders[idx];
        await restoreRecipientAndProductFrom(target);
        setStep(1); // 送付先ステップへ

      } else if (startAt === 'recipient') {
        if (addNew) clearRecipientAndProduct(); // 新規は空で開始
        recipientIndex = savedOrders.length + 1;
        updateRecipientStepLabel();
        setStep(1);

      } else {
        setStep(0);
      }

      clearOnce('startAt', 'editIndex', 'addNew');
    });
  })();
</script>
</body>
</html>